<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Activity Tracker</title>
  <link rel="stylesheet" href="/css/shared.css">
  <link rel="stylesheet" href="/css/admin.css">
  <script src="/js/ui-helper.js"></script>
  <script src="/js/help.js"></script>
</head>
<body data-ui-help-enabled="<%= uiHelpEnabled ? 'true' : 'false' %>">
  <nav class="navbar">
    <div class="container">
      <h1>Activity Tracker</h1>
      <ul class="nav-menu">
        <li><a href="/admin/dashboard">Dashboard</a></li>
        <li><a href="/admin/export">Export</a></li>
        <li><a href="/admin/shifts">Turni</a></li>
        <li><a href="/admin/settings" class="active">Configurazione</a></li>
        <li><a href="/admin/auth/logout">Logout</a></li>
      </ul>
    </div>
  </nav>

  <main class="container settings-container">
    <h2><%= title %></h2>

    <div id="alertContainer"></div>

    <div class="settings-section">
      <h3>Gestione Server</h3>
      <div class="alert alert-info">
        Riavvia il server dopo aver modificato le configurazioni per applicare le modifiche.
      </div>
      <div class="mb-20">
        <button type="button" onclick="restartServer(this)" class="btn btn-danger">
          üîÑ Riavvia Server
        </button>
        <span class="ml-10 text-muted text-small">
          Tutti gli utenti verranno temporaneamente disconnessi
        </span>
      </div>
    </div>

    <div class="settings-section">
      <h3>Configurazione Server</h3>
      <div class="alert alert-info">
        Le modifiche alla configurazione server richiedono il riavvio del server per essere applicate.
      </div>
      <form id="serverForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="serverPort">Porta Server
              <span class="ui-help-icon" data-ui-help="Porta di ascolto HTTP/HTTPS (1-65535). Su Windows Server 2022 usare una porta libera.">‚ìò</span>
            </label>
            <input type="number" id="serverPort" value="<%= settings.server.port %>" placeholder="3001" min="1" max="65535">
          </div>
          <div class="form-group">
            <label for="serverHost">Host Server
              <span class="ui-help-icon" data-ui-help="Interfaccia di ascolto. Usa 0.0.0.0 per tutte le interfacce o 127.0.0.1 per locale.">‚ìò</span>
            </label>
            <input type="text" id="serverHost" value="<%= settings.server.host %>" placeholder="0.0.0.0">
          </div>
          <div class="form-group">
            <label for="serverTrustProxy">Trust Proxy
              <span class="ui-help-icon" data-ui-help="Numero di proxy attendibili per ottenere l'IP reale e gestire cookie secure dietro proxy/terminazione TLS.">‚ìò</span>
            </label>
            <input type="number" id="serverTrustProxy" value="<%= settings.server.trustProxy %>" min="0" max="10">
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Salva Configurazione Server</button>
      </form>
      <div class="settings-subsection mt-20">
        <h4>Import / Export Configurazione Completa</h4>
        <p class="text-muted mb-12">
          Esporta o reimporta utenti, attivit√† e impostazioni server in un unico file JSON.
        </p>
        <div class="settings-actions">
          <button type="button" class="btn btn-primary" onclick="exportConfiguration(this)">
            ‚¨áÔ∏è Esporta configurazione
          </button>
          <input type="file" id="configImportFile" accept=".json" class="file-input">
          <button type="button" class="btn btn-primary" onclick="importConfiguration(this)">
            ‚¨ÜÔ∏è Importa configurazione
          </button>
        </div>
        <p class="settings-warning mt-10">
          L'importazione sovrascrive i dati presenti. Effettua un export di backup prima di procedere.
        </p>
      </div>
    </div>

    <div class="settings-section">
      <h3>Configurazione LDAP/Active Directory</h3>
      <div class="alert alert-info">
        Le modifiche alla configurazione LDAP richiedono il riavvio del server per essere applicate.
        <br><strong>LDAPS:</strong> Usa <code>ldaps://</code> invece di <code>ldap://</code> per connessioni sicure (porta 636).
      </div>
      <form id="ldapForm">
        <div class="form-group">
          <label>
            <input type="checkbox" id="ldapEnabled" <%= settings.ldap.enabled ? 'checked' : '' %>>
            Abilita autenticazione LDAP/AD
          </label>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="ldapUrl">URL LDAP/LDAPS
            </label>
            <input type="text" id="ldapUrl" value="<%= settings.ldap.url %>" placeholder="ldaps://dc.company.local:636">
          </div>
          <div class="form-group">
            <label for="ldapBaseDN">Base DN
            </label>
            <input type="text" id="ldapBaseDN" value="<%= settings.ldap.baseDN %>" placeholder="DC=company,DC=local">
          </div>
          <div class="form-group">
            <label for="ldapBindDN">Bind DN
            </label>
            <input type="text" id="ldapBindDN" value="<%= settings.ldap.bindDN %>" placeholder="CN=ServiceAccount,CN=Users,DC=company,DC=local">
          </div>
          <div class="form-group">
            <label for="ldapBindPassword">Bind Password
            </label>
            <input type="password" id="ldapBindPassword" value="<%= settings.ldap.bindPassword %>" placeholder="********">
            <div class="field-help">Usato per il test bind e la ricerca utenti.</div>
          </div>
          <div class="form-group">
            <label for="ldapUserSearchFilter">User Search Filter
            </label>
            <input type="text" id="ldapUserSearchFilter" value="<%= settings.ldap.userSearchFilter %>" placeholder="(sAMAccountName={{username}})">
          </div>
          <div class="form-group">
            <label for="ldapGroupSearchBase">Group Search Base
            </label>
            <input type="text" id="ldapGroupSearchBase" value="<%= settings.ldap.groupSearchBase %>" placeholder="OU=Groups,DC=company,DC=local">
          </div>
          <div class="form-group">
            <label for="ldapRequiredGroup">Gruppo Richiesto
            </label>
            <input type="text" id="ldapRequiredGroup" value="<%= settings.ldap.requiredGroup %>" placeholder="Domain Users">
          </div>
          <div class="form-group">
            <label for="ldapTimeout">Timeout (ms)
            </label>
            <input type="number" id="ldapTimeout" value="<%= settings.ldap.timeout %>" placeholder="5000" min="1000" max="60000">
          </div>
        </div>
        <div class="flex gap-12 align-center mt-12">
          <button type="button" onclick="testLdapBind(this)" class="btn btn-success">Test Bind LDAP</button>
          <span class="text-muted text-small">Esegui il test prima di salvare le modifiche LDAP.</span>
        </div>
        <button type="submit" class="btn btn-primary">Salva Configurazione LDAP</button>
      </form>
    </div>

    <div class="settings-section">
      <h3>Configurazione HTTPS</h3>
      <div class="alert alert-info">
        Raccomandato usare un reverse proxy (nginx/Apache) invece di HTTPS diretto. Le modifiche richiedono il riavvio del server.
      </div>
      <form id="httpsForm">
        <div class="form-group">
          <label>
            <input type="checkbox" id="httpsEnabled" <%= settings.https.enabled ? 'checked' : '' %>>
            Abilita HTTPS diretto
          </label>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="httpsCertPath">Percorso Certificato
            </label>
            <div class="flex gap-8 align-center">
              <input type="text" id="httpsCertPath" value="<%= settings.https.certPath || defaultHttpsCertPath %>" placeholder="<%= defaultHttpsCertPath %>">
              <button type="button" class="btn btn-sm" onclick="browseHttpsFile('httpsCertPath', this)">Esplora</button>
            </div>
            <div class="field-help">Precompilato dalla root progetto: <code><%= defaultHttpsCertPath %></code></div>
          </div>
          <div class="form-group">
            <label for="httpsKeyPath">Percorso Chiave Privata
            </label>
            <div class="flex gap-8 align-center">
              <input type="text" id="httpsKeyPath" value="<%= settings.https.keyPath || defaultHttpsKeyPath %>" placeholder="<%= defaultHttpsKeyPath %>">
              <button type="button" class="btn btn-sm" onclick="browseHttpsFile('httpsKeyPath', this)">Esplora</button>
            </div>
            <div class="field-help">Precompilato dalla root progetto: <code><%= defaultHttpsKeyPath %></code></div>
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Salva Configurazione HTTPS</button>
      </form>
    </div>

    <div class="settings-section">
      <h3>Logging</h3>
      <div class="alert alert-info">
        Configura il livello di logging e, se necessario, salva i log su file locale nel server Windows.
      </div>
      <form id="loggingForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="loggingLevel">Livello log
            </label>
            <select id="loggingLevel">
              <% ['trace','debug','info','warn','error','fatal'].forEach(level => { %>
                <option value="<%= level %>" <%= settings.logging.level === level ? 'selected' : '' %>><%= level %></option>
              <% }); %>
            </select>
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="loggingToFile" <%= settings.logging.toFile ? 'checked' : '' %>>
              Salva log su file locale
            </label>
          </div>
          <div class="form-group">
            <label for="loggingFilePath">Percorso file log
            </label>
            <div class="flex gap-8 align-center">
              <input type="text" id="loggingFilePath" value="<%= settings.logging.filePath %>">
              <button type="button" class="btn btn-sm" onclick="browseHttpsFile('loggingFilePath', this)">Esplora</button>
            </div>
            <div class="field-help">Il file verr√† creato sul server Windows. Nessuna scrittura sul PC client.</div>
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Salva Logging</button>
      </form>
    </div>

    <div class="settings-section">
      <h3>Test di Troubleshooting</h3>
      <div class="alert alert-info">
        Esegui i controlli per verificare connettivit√† e permessi prima di applicare modifiche.
        I test non cambiano la configurazione: simulano l'accesso a file e cartelle sul server Windows.
      </div>
      <div class="field-help">I risultati vengono mostrati come alert e confermano che il server pu√≤ accedere ai percorsi indicati.</div>
      <div class="settings-card-grid">
        <div class="settings-card">
          <h4>Test permessi storage</h4>
          <p>Verifica la possibilit√† di creare un file temporaneo nella directory dati configurata.</p>
          <div class="field-help">Usa il percorso impostato in "Storage".</div>
          <button type="button" onclick="runStorageTest(this)" class="btn btn-primary">Esegui test</button>
        </div>
        <div class="settings-card">
          <h4>Verifica file HTTPS</h4>
          <p>Controlla che i file certificato/chiave siano accessibili dal server.</p>
          <div class="field-help">Usa i percorsi indicati in "Configurazione HTTPS".</div>
          <button type="button" onclick="runHttpsTest(this)" class="btn btn-primary">Esegui test</button>
        </div>
      </div>
    </div>

    <div class="settings-section">
      <details>
        <summary class="collapsible-summary">Impostazioni Avanzate</summary>
        <div class="alert alert-info">
          Tutti i parametri server sono modificabili da qui. Salva e riavvia il server per applicare le modifiche.
        </div>
        <div class="field-help">Le impostazioni LDAP/AD rimangono nella sezione dedicata per evitare duplicazioni.</div>
        <form id="advancedSettingsForm">
        <div class="settings-subsection">
          <h4>JWT</h4>
          <div class="form-grid">
            <div class="form-group">
              <label for="advancedJwtSecret">JWT Secret
              </label>
              <input type="password" id="advancedJwtSecret" value="<%= settings.jwt.secret %>">
            </div>
            <div class="form-group">
              <label for="advancedJwtExpiresIn">JWT Expires In
              </label>
              <input type="text" id="advancedJwtExpiresIn" value="<%= settings.jwt.expiresIn %>">
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" id="advancedJwtRefreshEnabled" <%= settings.jwt.refreshEnabled ? 'checked' : '' %>>
                Abilita refresh token
              </label>
            </div>
          </div>
        </div>

        <div class="settings-subsection">
          <h4>Storage</h4>
          <div class="form-grid">
            <div class="form-group">
              <label for="advancedStorageRootPath">Percorso dati
              </label>
              <input type="text" id="advancedStorageRootPath" value="<%= settings.storage.rootPath %>">
            </div>
            <div class="form-group">
              <label for="advancedAuditRetentionDays">Retention audit (giorni)
              </label>
              <input type="number" id="advancedAuditRetentionDays" value="<%= settings.storage.auditRetentionDays %>" min="1" max="3650">
            </div>
            <div class="form-group">
              <label for="advancedAuditPayloadMode">Modalit√† payload audit
              </label>
              <input type="text" id="advancedAuditPayloadMode" value="<%= settings.storage.auditPayloadMode %>">
            </div>
          </div>
        </div>

        <div class="settings-subsection">
          <h4>Admin</h4>
          <div class="form-grid">
            <div class="form-group">
              <label for="advancedAdminSessionSecret">Session Secret
              </label>
              <input type="password" id="advancedAdminSessionSecret" value="<%= settings.admin.sessionSecret %>">
            </div>
            <div class="form-group">
              <label for="advancedAdminSessionMaxAge">Session Max Age (ms)
              </label>
              <input type="number" id="advancedAdminSessionMaxAge" value="<%= settings.admin.sessionMaxAge %>" min="60000" max="86400000">
            </div>
            <div class="form-group">
              <label for="advancedAdminDefaultUsername">Username default
              </label>
              <input type="text" id="advancedAdminDefaultUsername" value="<%= settings.admin.defaultUsername %>">
            </div>
            <div class="form-group">
              <label for="advancedAdminDefaultPassword">Password default
              </label>
              <input type="password" id="advancedAdminDefaultPassword" value="<%= settings.admin.defaultPassword %>">
            </div>
          </div>
        </div>

        <div class="settings-subsection">
          <h4>Sicurezza</h4>
          <div class="form-grid">
            <div class="form-group">
              <label for="advancedRateLimitWindowMs">Rate limit window (ms)
              </label>
              <input type="number" id="advancedRateLimitWindowMs" value="<%= settings.security.rateLimitWindowMs %>" min="1000" max="3600000">
            </div>
            <div class="form-group">
              <label for="advancedRateLimitMaxRequests">Rate limit max richieste
              </label>
              <input type="number" id="advancedRateLimitMaxRequests" value="<%= settings.security.rateLimitMaxRequests %>" min="1" max="10000">
            </div>
            <div class="form-group">
              <label for="advancedLoginRateLimitMax">Login max tentativi
              </label>
              <input type="number" id="advancedLoginRateLimitMax" value="<%= settings.security.loginRateLimitMax %>" min="1" max="50">
            </div>
            <div class="form-group">
              <label for="advancedLoginLockoutDurationMs">Durata lockout login (ms)
              </label>
              <input type="number" id="advancedLoginLockoutDurationMs" value="<%= settings.security.loginLockoutDurationMs %>" min="1000" max="3600000">
            </div>
            <div class="form-group">
              <label for="advancedCorsOrigin">CORS Origin
              </label>
              <input type="text" id="advancedCorsOrigin" value="<%= settings.security.corsOrigin %>">
            </div>
          </div>
        </div>

        <div class="settings-subsection">
          <h4>Attivit√†</h4>
          <div class="form-group">
            <label>
              <input type="checkbox" id="advancedActivityStrictContinuity" <%= settings.activity.strictContinuity ? 'checked' : '' %>>
              Abilita continuit√† stretta
            </label>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label for="advancedActivityRequiredMinutes">Minuti richiesti
              </label>
              <input type="number" id="advancedActivityRequiredMinutes" value="<%= settings.activity.requiredMinutes %>" min="1" max="1440">
            </div>
          </div>
        </div>

        <button type="submit" class="btn btn-primary">Salva Impostazioni Avanzate</button>
        </form>
      </details>
    </div>

    <div class="settings-section">
      <h3>Categorie Attivit√†</h3>
      <p>Gestisci le categorie disponibili nel menu a tendina per l'inserimento delle attivit√†.</p>

      <div class="activity-types-list" id="activityTypesList">
        <% activityTypes.forEach(type => { %>
        <div class="activity-type-tag">
          <%= type %>
          <button onclick="removeActivityType('<%= type %>', this)" title="Rimuovi">&times;</button>
        </div>
        <% }); %>
      </div>

      <form id="addActivityTypeForm" class="inline-form">
        <input type="text" id="newActivityType" placeholder="Nuova categoria...">
        <button type="submit" class="btn btn-success">Aggiungi</button>
      </form>
    </div>

    <div class="settings-section">
      <h3>Gestione Utenti Locali</h3>
      <p>Crea o elimina utenti con autenticazione locale. Gli utenti AD vengono gestiti automaticamente.</p>

      <button onclick="showCreateUserForm(this)" class="btn btn-success mb-16">+ Nuovo Utente Locale</button>

      <div id="createUserForm" class="panel mb-16" style="display: none;">
        <h4>Crea Nuovo Utente</h4>
        <form id="userCreateForm">
          <div class="form-grid">
            <div class="form-group">
              <label for="newUsername">Username:</label>
              <input type="text" id="newUsername" required>
            </div>
            <div class="form-group">
              <label for="newPassword">Password:</label>
              <input type="password" id="newPassword" required>
            </div>
            <div class="form-group">
              <label for="newDisplayName">Nome Completo:</label>
              <input type="text" id="newDisplayName">
            </div>
            <div class="form-group">
              <label for="newEmail">Email:</label>
              <input type="text" id="newEmail">
            </div>
            <div class="form-group">
              <label for="newDepartment">Reparto:</label>
              <input type="text" id="newDepartment">
            </div>
          </div>
          <div class="flex gap-8">
            <button type="submit" class="btn btn-primary">Crea Utente</button>
            <button type="button" onclick="hideCreateUserForm(this)" class="btn">Annulla</button>
          </div>
        </form>
      </div>

      <table class="users-table">
        <thead>
          <tr>
            <th>Username</th>
            <th>Nome Completo</th>
            <th>Tipo</th>
            <th>Reparto</th>
            <th>Turno</th>
            <th>Email</th>
            <th>Ultimo Login</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody id="usersTableBody">
          <% users.forEach(user => { %>
          <tr data-user-key="<%= user.userKey %>">
            <td><%= user.username %></td>
            <td>
              <% if (user.userType === 'ad') { %>
                <%= user.displayName %>
              <% } else { %>
                <input type="text"
                  id="displayName-<%= user.userKey %>"
                  value="<%= user.displayName %>"
                  class="table-input">
              <% } %>
            </td>
            <td>
              <span class="badge badge-<%= user.userType === 'ad' ? 'info' : 'secondary' %>">
                <%= user.userType === 'ad' ? 'AD' : 'Locale' %>
              </span>
            </td>
            <td>
              <% if (user.userType === 'ad') { %>
                <%= user.department || '-' %>
              <% } else { %>
                <input type="text"
                  id="dept-<%= user.userKey %>"
                  value="<%= user.department || '' %>"
                  class="table-input">
              <% } %>
            </td>
            <td>
              <select
                id="shift-<%= user.userKey %>"
                class="table-input">
                <option value="" <%= !user.shift ? 'selected' : '' %>>- Nessuno -</option>
                <% shiftTypes.forEach(shiftType => { %>
                <option value="<%= shiftType.name %>" <%= user.shift === shiftType.name ? 'selected' : '' %>><%= shiftType.name %></option>
                <% }); %>
              </select>
            </td>
            <td>
              <% if (user.userType === 'ad') { %>
                <%= user.email || '-' %>
              <% } else { %>
                <input type="email"
                  id="email-<%= user.userKey %>"
                  value="<%= user.email || '' %>"
                  class="table-input">
              <% } %>
            </td>
            <td><%= user.lastLoginAt ? new Date(user.lastLoginAt).toLocaleString('it-IT') : '-' %></td>
            <td>
              <div class="action-buttons">
                <button onclick="updateUserInfo('<%= user.userKey %>', '<%= user.userType %>', this)" class="btn btn-primary btn-sm">Imposta</button>
                <% if (user.userType !== 'ad') { %>
                <button onclick="resetUserPassword('<%= user.userKey %>', '<%= user.username %>', this)" class="btn btn-warning btn-sm">Reset Password</button>
                <button onclick="deleteUser('<%= user.userKey %>', '<%= user.username %>', this)" class="btn btn-danger btn-sm">Elimina</button>
                <% } %>
              </div>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </div>

    <div class="settings-section">
      <h3>Reset Password Admin</h3>
      <p>Imposta una nuova password per l'account admin attualmente autenticato.</p>
      <button onclick="resetAdminPassword(this)" class="btn btn-warning">Reset Password Admin</button>
    </div>
  </main>

  <script>
    let ldapBindTestFingerprint = null;
    let lastActionAnchor = null;

    function setLastActionAnchor(anchor) {
      if (anchor) {
        lastActionAnchor = anchor;
      }
    }

    function showAlert(message, type = 'success') {
      if (window.uiHelper && window.uiHelper.enabled) {
        const severityMap = {
          success: 'info',
          info: 'info',
          danger: 'error'
        };
        window.uiHelper.notify({
          anchor: lastActionAnchor || document.getElementById('alertContainer'),
          message,
          severity: severityMap[type] || 'info'
        });
        return;
      }
      const alertContainer = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      alertContainer.appendChild(alert);

      setTimeout(() => {
        alert.remove();
      }, 5000);
    }

    async function exportConfiguration(anchor) {
      setLastActionAnchor(anchor);
      try {
        const response = await fetch('/admin/api/settings/configuration/export');
        if (!response.ok) {
          throw new Error('Errore durante l\'export');
        }
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'configurazione-completa.json';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
        showAlert('Export completato', 'success');
      } catch (error) {
        showAlert('Errore durante l\'export della configurazione', 'danger');
      }
    }

    async function importConfiguration(anchor) {
      setLastActionAnchor(anchor);
      const fileInput = document.getElementById('configImportFile');
      if (!fileInput?.files?.length) {
        showAlert('Seleziona un file JSON da importare', 'danger');
        return;
      }

      if (!confirm('L\'importazione sovrascriver√† utenti, attivit√† e impostazioni. Continuare?')) {
        return;
      }

      const file = fileInput.files[0];
      try {
        const text = await file.text();
        const payload = JSON.parse(text);
        const response = await fetch('/admin/api/settings/configuration/import', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const result = await response.json();
        if (result.success) {
          showAlert(result.data.message || 'Import completato', 'success');
          if (confirm('Import completato. √à consigliato riavviare il server per applicare le impostazioni. Vuoi riavviare ora?')) {
            restartServer(lastActionAnchor);
          }
        } else {
          showAlert(result.error || 'Errore durante l\'import', 'danger');
        }
      } catch (error) {
        showAlert('File JSON non valido o errore durante l\'import', 'danger');
      }
    }

    document.getElementById('serverForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      setLastActionAnchor(e.submitter || document.querySelector('#serverForm button[type="submit"]'));

      const data = {
        port: document.getElementById('serverPort').value,
        host: document.getElementById('serverHost').value,
        trustProxy: document.getElementById('serverTrustProxy').value
      };

      try {
        const response = await fetch('/admin/api/settings/server', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
          showAlert(result.data.message, 'success');
          if (confirm('Le impostazioni sono state salvate. √à necessario riavviare il server per applicare le modifiche. Vuoi riavviare ora?')) {
            restartServer(lastActionAnchor);
          }
        } else {
          showAlert(result.error, 'danger');
        }
      } catch (error) {
        showAlert('Errore nel salvataggio della configurazione server', 'danger');
      }
    });

    document.getElementById('ldapForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      setLastActionAnchor(e.submitter || document.querySelector('#ldapForm button[type="submit"]'));

      const data = {
        enabled: document.getElementById('ldapEnabled').checked,
        url: document.getElementById('ldapUrl').value,
        baseDN: document.getElementById('ldapBaseDN').value,
        bindDN: document.getElementById('ldapBindDN').value,
        bindPassword: document.getElementById('ldapBindPassword').value,
        userSearchFilter: document.getElementById('ldapUserSearchFilter').value,
        groupSearchBase: document.getElementById('ldapGroupSearchBase').value,
        requiredGroup: document.getElementById('ldapRequiredGroup').value,
        timeout: document.getElementById('ldapTimeout').value
      };

      if (data.enabled && data.bindDN) {
        const currentFingerprint = JSON.stringify({
          url: data.url,
          bindDN: data.bindDN,
          bindPassword: data.bindPassword,
          timeout: data.timeout
        });
        if (ldapBindTestFingerprint !== currentFingerprint) {
          showAlert('Esegui il test bind LDAP con le credenziali correnti prima di salvare.', 'danger');
          return;
        }
      }

      try {
        const response = await fetch('/admin/api/settings/ldap', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
          showAlert(result.data.message, 'success');
          if (confirm('Le impostazioni sono state salvate. √à necessario riavviare il server per applicare le modifiche. Vuoi riavviare ora?')) {
            restartServer(lastActionAnchor);
          }
        } else {
          showAlert(result.error, 'danger');
        }
      } catch (error) {
        showAlert('Errore nel salvataggio della configurazione LDAP', 'danger');
      }
    });

    async function testLdapBind(anchor) {
      setLastActionAnchor(anchor);
      const payload = {
        url: document.getElementById('ldapUrl').value,
        bindDN: document.getElementById('ldapBindDN').value,
        bindPassword: document.getElementById('ldapBindPassword').value,
        timeout: document.getElementById('ldapTimeout').value
      };

      try {
        const response = await fetch('/admin/api/settings/ldap/test-bind', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        if (result.success) {
          ldapBindTestFingerprint = JSON.stringify(payload);
          showAlert(result.data.message || 'Test LDAP riuscito', 'success');
        } else {
          showAlert(result.error, 'danger');
        }
      } catch (error) {
        showAlert('Errore durante il test bind LDAP', 'danger');
      }
    }

    document.getElementById('httpsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      setLastActionAnchor(e.submitter || document.querySelector('#httpsForm button[type="submit"]'));

      const data = {
        enabled: document.getElementById('httpsEnabled').checked,
        certPath: document.getElementById('httpsCertPath').value,
        keyPath: document.getElementById('httpsKeyPath').value
      };

      try {
        const response = await fetch('/admin/api/settings/https', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
          showAlert(result.data.message, 'success');
          if (confirm('Le impostazioni sono state salvate. √à necessario riavviare il server per applicare le modifiche. Vuoi riavviare ora?')) {
            restartServer();
          }
        } else {
          showAlert(result.error, 'danger');
        }
      } catch (error) {
        showAlert('Errore nel salvataggio della configurazione HTTPS', 'danger');
      }
    });

    document.getElementById('addActivityTypeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      setLastActionAnchor(e.submitter || document.querySelector('#addActivityTypeForm button[type="submit"]'));

      const newType = document.getElementById('newActivityType').value.trim();
      if (!newType) return;

      try {
        const response = await fetch('/admin/api/settings/activity-types/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ activityType: newType })
        });

        const result = await response.json();
        if (result.success) {
          showAlert('Categoria aggiunta con successo', 'success');
          location.reload();
        } else {
          showAlert(result.error, 'danger');
        }
      } catch (error) {
        showAlert('Errore nell\'aggiunta della categoria', 'danger');
      }
    });

    async function removeActivityType(type, anchor) {
      setLastActionAnchor(anchor);
      if (!confirm(`Sei sicuro di voler rimuovere la categoria "${type}"?`)) {
        return;
      }

      try {
        const response = await fetch(`/admin/api/settings/activity-types/${encodeURIComponent(type)}`, {
          method: 'DELETE'
        });

        const result = await response.json();
        if (result.success) {
          showAlert('Categoria rimossa con successo', 'success');
          location.reload();
        } else {
          showAlert(result.error, 'danger');
        }
      } catch (error) {
        showAlert('Errore nella rimozione della categoria', 'danger');
      }
    }

    document.getElementById('advancedSettingsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      setLastActionAnchor(e.submitter || document.querySelector('#advancedSettingsForm button[type="submit"]'));

      const data = {
        jwt: {
          secret: document.getElementById('advancedJwtSecret').value,
          expiresIn: document.getElementById('advancedJwtExpiresIn').value,
          refreshEnabled: document.getElementById('advancedJwtRefreshEnabled').checked
        },
        storage: {
          rootPath: document.getElementById('advancedStorageRootPath').value,
          auditRetentionDays: document.getElementById('advancedAuditRetentionDays').value,
          auditPayloadMode: document.getElementById('advancedAuditPayloadMode').value
        },
        admin: {
          sessionSecret: document.getElementById('advancedAdminSessionSecret').value,
          sessionMaxAge: document.getElementById('advancedAdminSessionMaxAge').value,
          defaultUsername: document.getElementById('advancedAdminDefaultUsername').value,
          defaultPassword: document.getElementById('advancedAdminDefaultPassword').value
        },
        security: {
          rateLimitWindowMs: document.getElementById('advancedRateLimitWindowMs').value,
          rateLimitMaxRequests: document.getElementById('advancedRateLimitMaxRequests').value,
          loginRateLimitMax: document.getElementById('advancedLoginRateLimitMax').value,
          loginLockoutDurationMs: document.getElementById('advancedLoginLockoutDurationMs').value,
          corsOrigin: document.getElementById('advancedCorsOrigin').value
        },
        activity: {
          strictContinuity: document.getElementById('advancedActivityStrictContinuity').checked,
          requiredMinutes: document.getElementById('advancedActivityRequiredMinutes').value
        }
      };

      try {
        const response = await fetch('/admin/api/settings/advanced', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
          showAlert(result.data.message, 'success');
          if (confirm('Le impostazioni avanzate sono state salvate. √à necessario riavviare il server per applicare le modifiche. Vuoi riavviare ora?')) {
            restartServer();
          }
        } else {
          showAlert(result.error, 'danger');
        }
      } catch (error) {
        showAlert('Errore nel salvataggio delle impostazioni avanzate', 'danger');
      }
    });

    document.getElementById('loggingForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      setLastActionAnchor(e.submitter || document.querySelector('#loggingForm button[type="submit"]'));

      const data = {
        logging: {
          level: document.getElementById('loggingLevel').value,
          toFile: document.getElementById('loggingToFile').checked,
          filePath: document.getElementById('loggingFilePath').value
        }
      };

      try {
        const response = await fetch('/admin/api/settings/advanced', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
          showAlert(result.data.message, 'success');
          if (confirm('Le impostazioni di logging sono state salvate. √à necessario riavviare il server per applicare le modifiche. Vuoi riavviare ora?')) {
            restartServer();
          }
        } else {
          showAlert(result.error, 'danger');
        }
      } catch (error) {
        showAlert('Errore nel salvataggio delle impostazioni di logging', 'danger');
      }
    });

    function browseHttpsFile(targetId, anchor) {
      setLastActionAnchor(anchor);
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.style.display = 'none';
      fileInput.addEventListener('change', () => {
        if (fileInput.files && fileInput.files.length > 0) {
          const fileName = fileInput.files[0].name;
          document.getElementById(targetId).value = fileName;
          showAlert('File selezionato. Inserisci il percorso assoluto sul server Windows se diverso.', 'info');
        }
      });
      document.body.appendChild(fileInput);
      fileInput.click();
      document.body.removeChild(fileInput);
    }

    async function runStorageTest(anchor) {
      setLastActionAnchor(anchor);
      try {
        const response = await fetch('/admin/api/settings/troubleshoot', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type: 'storage',
            payload: {
              rootPath: document.getElementById('advancedStorageRootPath')?.value
            }
          })
        });
        const result = await response.json();
        if (result.success) {
          showAlert(result.data.message, 'success');
        } else {
          showAlert(result.error, 'danger');
        }
      } catch (error) {
        showAlert('Errore durante il test storage', 'danger');
      }
    }

    async function runHttpsTest(anchor) {
      setLastActionAnchor(anchor);
      try {
        const response = await fetch('/admin/api/settings/troubleshoot', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type: 'https',
            payload: {
              certPath: document.getElementById('httpsCertPath')?.value,
              keyPath: document.getElementById('httpsKeyPath')?.value
            }
          })
        });
        const result = await response.json();
        if (result.success) {
          showAlert(result.data.message, 'success');
        } else {
          showAlert(result.error, 'danger');
        }
      } catch (error) {
        showAlert('Errore durante il test HTTPS', 'danger');
      }
    }

    function showCreateUserForm(anchor) {
      setLastActionAnchor(anchor);
      document.getElementById('createUserForm').style.display = 'block';
    }

    function hideCreateUserForm(anchor) {
      setLastActionAnchor(anchor);
      document.getElementById('createUserForm').style.display = 'none';
      document.getElementById('userCreateForm').reset();
    }

    document.getElementById('userCreateForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      setLastActionAnchor(e.submitter || document.querySelector('#userCreateForm button[type="submit"]'));

      const data = {
        username: document.getElementById('newUsername').value,
        password: document.getElementById('newPassword').value,
        displayName: document.getElementById('newDisplayName').value,
        email: document.getElementById('newEmail').value,
        department: document.getElementById('newDepartment').value
      };

      try {
        const response = await fetch('/admin/api/users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
          showAlert('Utente creato con successo', 'success');
          hideCreateUserForm();
          location.reload();
        } else {
          showAlert(result.error, 'danger');
        }
      } catch (error) {
        showAlert('Errore nella creazione dell\'utente', 'danger');
      }
    });

    async function deleteUser(userKey, username, anchor) {
      setLastActionAnchor(anchor);
      if (!confirm(`Sei sicuro di voler eliminare l'utente "${username}"?`)) {
        return;
      }

      try {
        const response = await fetch(`/admin/api/users/${userKey}`, {
          method: 'DELETE'
        });

        const result = await response.json();
        if (result.success) {
          showAlert('Utente eliminato con successo', 'success');
          location.reload();
        } else {
          showAlert(result.error, 'danger');
        }
      } catch (error) {
        showAlert('Errore nell\'eliminazione dell\'utente', 'danger');
      }
    }

    async function updateUserInfo(userKey, userType, anchor) {
      setLastActionAnchor(anchor);
      const shiftValue = document.getElementById(`shift-${userKey}`).value;
      const updates = {
        shift: shiftValue || null
      };

      if (userType !== 'ad') {
        const displayNameValue = document.getElementById(`displayName-${userKey}`).value;
        const deptValue = document.getElementById(`dept-${userKey}`).value;
        const emailValue = document.getElementById(`email-${userKey}`).value;
        updates.displayName = displayNameValue || null;
        updates.department = deptValue || null;
        updates.email = emailValue || null;
      }

      try {
        const response = await fetch(`/admin/api/users/${userKey}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updates)
        });

        const result = await response.json();
        if (result.success) {
          showAlert('Informazioni utente aggiornate con successo', 'success');
        } else {
          showAlert(result.error, 'danger');
        }
      } catch (error) {
        showAlert('Errore nell\'aggiornamento delle informazioni utente', 'danger');
      }
    }

    async function resetUserPassword(userKey, username, anchor) {
      setLastActionAnchor(anchor);
      const newPassword = prompt(`Inserisci la nuova password per "${username}":`);
      if (!newPassword) {
        return;
      }

      try {
        const response = await fetch(`/admin/api/users/${userKey}/reset-password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ newPassword })
        });

        const result = await response.json();
        if (result.success) {
          showAlert('Password reimpostata con successo', 'success');
        } else {
          showAlert(result.error, 'danger');
        }
      } catch (error) {
        showAlert('Errore nel reset della password', 'danger');
      }
    }

    async function resetAdminPassword(anchor) {
      setLastActionAnchor(anchor);
      const newPassword = prompt('Inserisci la nuova password admin:');
      if (!newPassword) {
        return;
      }

      try {
        const response = await fetch('/admin/api/admin/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ newPassword })
        });

        const result = await response.json();
        if (result.success) {
          showAlert('Password admin aggiornata con successo', 'success');
        } else {
          showAlert(result.error, 'danger');
        }
      } catch (error) {
        showAlert('Errore nel reset della password admin', 'danger');
      }
    }

    async function restartServer(anchor) {
      setLastActionAnchor(anchor);
      if (!confirm('Sei sicuro di voler riavviare il server? Tutti gli utenti verranno disconnessi temporaneamente.')) {
        return;
      }

      try {
        const response = await fetch('/admin/api/server/restart', {
          method: 'POST'
        });

        const result = await response.json();
        if (result.success) {
          showAlert('Server in riavvio... Ricarica la pagina tra 5 secondi.', 'success');

          setTimeout(() => {
            window.location.reload();
          }, 5000);
        } else {
          showAlert(result.error, 'danger');
        }
      } catch (error) {
        showAlert('Server in riavvio... Ricarica la pagina tra 5 secondi.', 'info');
        setTimeout(() => {
          window.location.reload();
        }, 5000);
      }
    }
  </script>
  <script>
    helpSystem.init(adminSettingsHelp);
  </script>
</body>
</html>
