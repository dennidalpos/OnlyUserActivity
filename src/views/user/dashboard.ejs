<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Activity Tracker</title>
  <link rel="stylesheet" href="/css/user.css">
  <script src="/js/ui-helper.js"></script>
  <script src="/js/help.js"></script>
</head>
<body data-ui-help-enabled="<%= uiHelpEnabled ? 'true' : 'false' %>">
  <nav class="navbar">
    <div class="navbar-brand">
      <h1>Activity Tracker</h1>
    </div>
    <div class="navbar-user">
      <span>
        Benvenuto, <strong><%= user.displayName %></strong>
        <span class="badge badge-<%= user.userType === 'ad' ? 'info' : 'secondary' %>" style="margin-left: 8px; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
          <%= user.userType === 'ad' ? 'AD' : 'Locale' %>
        </span>
      </span>
      <a href="/user/auth/logout" class="btn btn-sm">Logout</a>
    </div>
  </nav>

  <div class="container">
    <div class="header">
      <h2>Le Tue Attività</h2>
      <div class="date-selector">
        <input type="date" id="activityDate" value="<%= currentDate %>" class="form-control" data-ui-help="Scegli la data di lavoro da visualizzare." data-ui-severity="info">
        <button onclick="loadActivities(this)" class="btn btn-primary" data-ui-help="Carica le attività e aggiorna le statistiche della giornata." data-ui-severity="info">Carica</button>
        <button onclick="setToday(this)" class="btn" data-ui-help="Imposta rapidamente la data odierna." data-ui-severity="info">Oggi</button>
      </div>
    </div>

    <div class="summary-cards">
      <div class="card">
        <h3>Ore Lavorate</h3>
        <p class="stat" id="totalHours">-</p>
      </div>
      <div class="card">
        <h3>Straordinari</h3>
        <p class="stat" id="overtime">-</p>
      </div>
      <div class="card">
        <h3>Attività</h3>
        <p class="stat" id="activityCount">-</p>
      </div>
      <div class="card">
        <h3>Completamento Giornata</h3>
        <p class="stat" id="dayStatus">-</p>
        <div class="progress-bar-container">
          <div class="progress-bar" id="progressBar">
            <div class="progress-bar-fill" id="progressBarFill"></div>
          </div>
          <span class="progress-text" id="progressText">0%</span>
        </div>
      </div>
    </div>

    <div class="shift-info-card">
      <div>
        <h3>Tipo di Turno Associato</h3>
        <p class="shift-name"><%= userShift ? userShift.name : 'Nessun turno assegnato' %></p>
      </div>
      <% if (userShift) { %>
      <div class="shift-meta">
        <span class="shift-badge"><%= userShift.includeWeekends ? 'Include weekend' : 'Esclude weekend' %></span>
        <span class="shift-badge"><%= userShift.includeHolidays ? 'Include festività' : 'Esclude festività' %></span>
      </div>
      <% } %>
    </div>

    <div class="activity-section">
      <div class="section-header">
        <h3>Gestione Attività</h3>
        <button onclick="showAddActivity(this)" class="btn btn-primary" data-ui-help="Apri il form per registrare una nuova attività." data-ui-severity="info">+ Nuova Attività</button>
      </div>

      <div id="addActivityForm" class="activity-form" style="display: none;">
        <h4>Aggiungi Attività</h4>
        <form onsubmit="addActivity(event)">
          <div class="form-row">
            <div class="form-group">
              <label>Ore</label>
              <select id="durationHours" required data-ui-help="Seleziona le ore di durata." data-ui-severity="info"></select>
            </div>
            <div class="form-group">
              <label>Minuti</label>
              <select id="durationMinutes" required data-ui-help="Seleziona i minuti di durata (15/30/45)." data-ui-severity="info"></select>
            </div>
            <div class="form-group">
              <label>Tipo Attività</label>
              <select id="activityType" required data-ui-help="Scegli la categoria che descrive l'attività svolta." data-ui-severity="info">
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Note</label>
            <textarea id="notes" rows="2" placeholder="Descrizione attività..." data-ui-help="Inserisci dettagli utili o contesto per l'attività." data-ui-severity="info"></textarea>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary" data-ui-help="Salva l'attività o aggiorna quella selezionata." data-ui-severity="info">Salva</button>
            <button type="button" onclick="cancelAdd(this)" class="btn" data-ui-help="Chiudi il form senza salvare." data-ui-severity="warn">Annulla</button>
          </div>
        </form>
      </div>

      <div id="activitiesList" class="activities-list">
        <p class="loading">Caricamento...</p>
      </div>
    </div>

    <div class="calendar-section">
      <div class="section-header">
        <h3>Calendario Mensile</h3>
        <div class="calendar-nav">
          <button type="button" class="btn btn-sm" onclick="navigateMonth(-1, this)" data-ui-help="Vai al mese precedente." data-ui-severity="info">&larr;</button>
          <span id="calendarMonthLabel"></span>
          <button type="button" class="btn btn-sm" onclick="navigateMonth(1, this)" data-ui-help="Vai al mese successivo." data-ui-severity="info">&rarr;</button>
        </div>
      </div>

      <div class="calendar-legend">
        <span class="legend-item legend-ok">OK</span>
        <span class="legend-item legend-incomplete">Incompleto</span>
        <span class="legend-item legend-missing">Non inserito</span>
        <span class="legend-item legend-off">Non richiesto</span>
      </div>

      <div class="calendar-grid" id="calendarGrid"></div>

      <div class="calendar-actions">
        <h4>Imposta giornata intera</h4>
        <div class="quick-actions">
          <button type="button" class="btn btn-primary" onclick="applyQuickDay('malattia', this)">Malattia</button>
          <button type="button" class="btn btn-primary" onclick="applyQuickDay('ferie', this)">Ferie</button>
          <button type="button" class="btn btn-primary" onclick="applyQuickDay('permesso', this, { label: 'Congedo' })">Congedo</button>
          <button type="button" class="btn btn-primary" onclick="applyQuickDay('lavoro', this, { label: 'Smart working', notes: 'Smart working' })">Smart working</button>
        </div>
        <p class="calendar-hint">Seleziona un giorno dal calendario per applicare la giornata intera.</p>
      </div>

      <div class="calendar-irregularities">
        <h4>Irregolarità fuori mese corrente</h4>
        <div id="irregularityShortcuts" class="irregularity-shortcuts">
          <p class="no-data">Nessuna irregolarità trovata.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const token = '<%= token %>';
    let currentDate = '<%= currentDate %>';
    let editingActivityId = null;
    let activityTypes = [];
    let requiredMinutes = 480;
    let calendarDate = '<%= currentDate %>';
    let selectedCalendarDate = '<%= currentDate %>';

    console.log('Dashboard script loaded. Token:', token ? 'present' : 'missing');

    async function loadActivityTypes() {
      try {
        const response = await fetch('/api/activities/types', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        const result = await response.json();
        if (result.success) {
          activityTypes = result.data;
          populateActivityTypeSelect();
        }
      } catch (error) {
        console.error('Error loading activity types:', error);
        activityTypes = ['lavoro', 'meeting', 'formazione'];
        populateActivityTypeSelect();
      }
    }

    function populateActivityTypeSelect() {
      const select = document.getElementById('activityType');
      select.innerHTML = '';
      activityTypes.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
        select.appendChild(option);
      });
    }

    function populateDurationSelects() {
      const hoursSelect = document.getElementById('durationHours');
      const minutesSelect = document.getElementById('durationMinutes');
      hoursSelect.innerHTML = '';
      minutesSelect.innerHTML = '';

      for (let i = 0; i <= 24; i += 1) {
        const option = document.createElement('option');
        option.value = String(i);
        option.textContent = `${i}h`;
        hoursSelect.appendChild(option);
      }

      [0, 15, 30, 45].forEach(min => {
        const option = document.createElement('option');
        option.value = String(min);
        option.textContent = `${min}m`;
        minutesSelect.appendChild(option);
      });
    }

    function setDurationSelectValues(durationMinutesValue) {
      const hoursSelect = document.getElementById('durationHours');
      const minutesSelect = document.getElementById('durationMinutes');
      const hours = Math.max(0, Math.floor(durationMinutesValue / 60));
      const minutes = durationMinutesValue % 60;

      hoursSelect.value = String(Math.min(hours, 24));
      minutesSelect.value = String([0, 15, 30, 45].includes(minutes) ? minutes : 0);
    }

    function setToday(anchor) {
      console.log('setToday called');
      lastActionAnchor = anchor || document.getElementById('activityDate');
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('activityDate').value = today;
      loadActivities();
    }

    let lastActionAnchor = null;

    async function loadActivities(anchor) {
      lastActionAnchor = anchor || document.getElementById('activityDate');
      console.log('loadActivities called for date:', document.getElementById('activityDate')?.value);
      const date = document.getElementById('activityDate').value;
      currentDate = date;
      selectedCalendarDate = date;
      const [year, month] = date.split('-');
      const monthPrefix = `${year}-${month}`;
      if (!calendarDate.startsWith(monthPrefix)) {
        calendarDate = `${year}-${month}-01`;
        loadMonthCalendar();
      } else {
        highlightSelectedCalendarDay();
      }

      try {
        console.log('Fetching activities from API...');
        const response = await fetch(`/api/activities/${date}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        console.log('API response status:', response.status);
        const result = await response.json();
        console.log('API result:', result);

        if (result.success) {
          displayActivities(result.data);
        } else {
          showError(result.error.message);
        }
      } catch (error) {
        console.error('Error loading activities:', error);
        showError('Errore nel caricamento delle attività');
      }
    }

    function displayActivities(data) {
      const activities = data.activities || [];
      const summary = data.summary || {};

      const totalMinutes = Number.isFinite(summary.totalMinutes) ? summary.totalMinutes : 0;
      requiredMinutes = Number.isFinite(summary.requiredMinutes) ? summary.requiredMinutes : 480;

      document.getElementById('totalHours').textContent =
        `${Math.floor(totalMinutes / 60)}h ${totalMinutes % 60}m`;

      const overtimeMinutes = totalMinutes > requiredMinutes ? totalMinutes - requiredMinutes : 0;
      const overtimeHours = Math.floor(overtimeMinutes / 60);
      const overtimeMins = overtimeMinutes % 60;
      document.getElementById('overtime').textContent = overtimeMinutes > 0
        ? `${overtimeHours}h ${overtimeMins}m`
        : '-';
      document.getElementById('overtime').style.color = overtimeMinutes > 0 ? '#28a745' : '#999';

      document.getElementById('activityCount').textContent = activities.length;
      const completionPercentage = requiredMinutes > 0
        ? Math.min(100, Math.round((totalMinutes / requiredMinutes) * 100))
        : 0;
      const progressBarFill = document.getElementById('progressBarFill');
      const progressText = document.getElementById('progressText');

      progressBarFill.style.width = completionPercentage + '%';
      progressText.textContent = completionPercentage + '%';

      if (completionPercentage === 0) {
        document.getElementById('dayStatus').textContent = 'Non inserito';
      } else if (completionPercentage === 100) {
        document.getElementById('dayStatus').textContent = 'OK';
      } else {
        document.getElementById('dayStatus').textContent = 'Incompleta';
      }

      if (completionPercentage < 50) {
        progressBarFill.style.backgroundColor = '#dc3545';
      } else if (completionPercentage < 100) {
        progressBarFill.style.backgroundColor = '#ffc107';
      } else {
        progressBarFill.style.backgroundColor = '#28a745';
      }

      const list = document.getElementById('activitiesList');

      if (activities.length === 0) {
        list.innerHTML = '<p class="no-data">Nessuna attività per questa data</p>';
        return;
      }

      list.innerHTML = activities.map(activity => {
        const hours = Math.floor(activity.durationMinutes / 60);
        const mins = activity.durationMinutes % 60;
        const durationText = hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
        const activityTypeFormatted = activity.activityType.charAt(0).toUpperCase() + activity.activityType.slice(1);

        const dateObj = new Date(currentDate + 'T00:00:00');
        const dateFormatted = dateObj.toLocaleDateString('it-IT', {
          weekday: 'short',
          day: '2-digit',
          month: 'short',
          year: 'numeric'
        });

        return `
          <div class="activity-item" data-activity-id="${activity.id}">
            <div class="activity-header">
              <div class="activity-info">
                <span class="activity-type badge badge-${activity.activityType}">${activityTypeFormatted}</span>
                <span class="activity-duration">
                  <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: text-bottom; margin-right: 3px;">
                    <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0zM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0z"/>
                    <path d="M8 4.5a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3.5a.5.5 0 0 1-.5-.5V5a.5.5 0 0 1 .5-.5z"/>
                  </svg>
                  Durata: ${durationText}
                </span>
                <span class="activity-date">
                  <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: text-bottom; margin-right: 3px;">
                    <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/>
                  </svg>
                  ${dateFormatted}
                </span>
              </div>
              <div class="activity-actions">
                <button onclick="editActivity('${activity.id}', this)" class="btn btn-sm btn-primary" data-ui-help="Modifica orari, categoria o note dell'attività selezionata." data-ui-severity="info">
                  <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: text-bottom;">
                    <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                  </svg>
                  Modifica
                </button>
                <button onclick="deleteActivity('${activity.id}', this)" class="btn btn-sm btn-danger" data-ui-help="Elimina definitivamente l'attività selezionata." data-ui-severity="warn">
                  <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: text-bottom;">
                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                  </svg>
                  Elimina
                </button>
              </div>
            </div>
            ${activity.notes ? `<div class="activity-notes">
              <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: text-bottom; margin-right: 4px;">
                <path d="M5 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2H5zm0 1h6a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1z"/>
                <path d="M3 5.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 8a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 8zm0 2.5a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5z"/>
              </svg>
              ${activity.notes}
            </div>` : ''}
          </div>
        `;
      }).join('');

      window.currentActivities = activities;
      if (window.uiHelper) {
        window.uiHelper.bindHelpTargets(list);
      }
    }

    function showAddActivity(anchor) {
      console.log('showAddActivity called');
      lastActionAnchor = anchor || document.getElementById('addActivityForm');
      editingActivityId = null;
      document.getElementById('addActivityForm').style.display = 'block';
      setDurationSelectValues(requiredMinutes);
      document.getElementById('activityType').value = activityTypes[0] || 'lavoro';
      document.getElementById('notes').value = '';

      document.querySelector('#addActivityForm h4').textContent = 'Aggiungi Attività';
      document.querySelector('#addActivityForm button[type="submit"]').textContent = 'Salva';
    }

    function editActivity(activityId, anchor) {
      console.log('editActivity called for:', activityId);
      lastActionAnchor = anchor || document.getElementById('addActivityForm');

      const activity = window.currentActivities?.find(a => a.id === activityId);
      if (!activity) {
        showError('Attività non trovata');
        return;
      }

      editingActivityId = activityId;
      document.getElementById('addActivityForm').style.display = 'block';
      setDurationSelectValues(activity.durationMinutes);
      document.getElementById('activityType').value = activity.activityType;
      document.getElementById('notes').value = activity.notes || '';

      document.querySelector('#addActivityForm h4').textContent = 'Modifica Attività';
      document.querySelector('#addActivityForm button[type="submit"]').textContent = 'Aggiorna';

      document.getElementById('addActivityForm').scrollIntoView({ behavior: 'smooth' });
    }

    function cancelAdd(anchor) {
      console.log('cancelAdd called');
      lastActionAnchor = anchor || document.getElementById('addActivityForm');
      document.getElementById('addActivityForm').style.display = 'none';
      editingActivityId = null;
      document.querySelector('#addActivityForm h4').textContent = 'Aggiungi Attività';
      document.querySelector('#addActivityForm button[type="submit"]').textContent = 'Salva';
    }

    async function addActivity(event) {
      console.log('addActivity called', editingActivityId ? '(UPDATE mode)' : '(CREATE mode)');
      event.preventDefault();
      lastActionAnchor = event.submitter || document.querySelector('#addActivityForm button[type="submit"]');

      const data = {
        durationHours: Number(document.getElementById('durationHours').value),
        durationMinutes: Number(document.getElementById('durationMinutes').value),
        activityType: document.getElementById('activityType').value,
        notes: document.getElementById('notes').value
      };

      if (!editingActivityId) {
        data.date = currentDate;
      }

      console.log(editingActivityId ? 'Updating' : 'Creating', 'activity with data:', data);

      try {
        let url, method;

        if (editingActivityId) {
          url = `/api/activities/${editingActivityId}?date=${currentDate}`;
          method = 'PUT';
        } else {
          url = '/api/activities';
          method = 'POST';
        }

        const response = await fetch(url, {
          method: method,
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        console.log('Response status:', response.status);
        const result = await response.json();
        console.log('Result:', result);

        if (result.success) {
          cancelAdd();
          loadActivities();
          loadMonthCalendar();
          showSuccess(editingActivityId ? 'Attività aggiornata con successo' : 'Attività aggiunta con successo');
        } else {
          showError(result.error?.message || result.error || 'Errore sconosciuto');
        }
      } catch (error) {
        console.error('Error saving activity:', error);
        showError('Errore nel salvataggio dell\'attività');
      }
    }

    async function deleteActivity(activityId, anchor) {
      lastActionAnchor = anchor || document.querySelector(`[data-activity-id="${activityId}"]`);
      if (!confirm('Sei sicuro di voler eliminare questa attività?')) {
        return;
      }

      try {
        const response = await fetch(`/api/activities/${activityId}?date=${currentDate}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        const result = await response.json();

        if (result.success) {
          loadActivities();
          loadMonthCalendar();
          showSuccess('Attività eliminata');
        } else {
          showError(result.error.message);
        }
      } catch (error) {
        showError('Errore nell\'eliminazione');
      }
    }

    function showError(message) {
      console.error('showError:', message);
      if (window.uiHelper && window.uiHelper.enabled) {
        window.uiHelper.notify({
          anchor: lastActionAnchor || document.getElementById('activitiesList'),
          message: message,
          severity: 'error'
        });
        return;
      }
      alert('Errore: ' + message);
    }

    function showSuccess(message) {
      console.log('showSuccess:', message);
      if (window.uiHelper && window.uiHelper.enabled) {
        window.uiHelper.notify({
          anchor: lastActionAnchor || document.getElementById('activitiesList'),
          message: message,
          severity: 'info'
        });
        return;
      }
      alert(message);
    }

    function formatMonthLabel(dateString) {
      const date = new Date(`${dateString}T00:00:00`);
      return date.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });
    }

    function selectCalendarDate(dateString) {
      selectedCalendarDate = dateString;
      document.getElementById('activityDate').value = dateString;
      currentDate = dateString;
      loadActivities();

      const [year, month] = dateString.split('-');
      const currentMonthPrefix = `${year}-${month}`;
      if (!calendarDate.startsWith(currentMonthPrefix)) {
        calendarDate = `${year}-${month}-01`;
        loadMonthCalendar();
      } else {
        highlightSelectedCalendarDay();
      }
    }

    function highlightSelectedCalendarDay() {
      document.querySelectorAll('.calendar-day').forEach(cell => {
        const dateValue = cell.getAttribute('data-date');
        if (dateValue === selectedCalendarDate) {
          cell.classList.add('selected');
        } else {
          cell.classList.remove('selected');
        }
      });
    }

    function renderCalendar(days, year, month) {
      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';
      const dayNames = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'];

      dayNames.forEach(name => {
        const header = document.createElement('div');
        header.className = 'calendar-day calendar-day-header';
        header.textContent = name;
        grid.appendChild(header);
      });

      const firstDay = new Date(year, month - 1, 1);
      const startOffset = (firstDay.getDay() + 6) % 7;

      for (let i = 0; i < startOffset; i += 1) {
        const empty = document.createElement('div');
        empty.className = 'calendar-day calendar-day-empty';
        grid.appendChild(empty);
      }

      days.forEach(day => {
        const cell = document.createElement('button');
        cell.type = 'button';
        cell.className = 'calendar-day';
        const dateObj = new Date(`${day.date}T00:00:00`);
        cell.innerHTML = `<span>${dateObj.getDate()}</span>`;
        cell.setAttribute('data-date', day.date);

        if (!day.isRequired) {
          cell.classList.add('day-off');
        } else if (day.status === 'OK') {
          cell.classList.add('day-ok');
        } else if (day.status === 'Incompleto') {
          cell.classList.add('day-incomplete');
        } else {
          cell.classList.add('day-missing');
        }

        if (day.isFuture) {
          cell.classList.add('day-future');
        }

        if (day.date === selectedCalendarDate) {
          cell.classList.add('selected');
        }

        cell.addEventListener('click', () => selectCalendarDate(day.date));
        grid.appendChild(cell);
      });
    }

    function renderIrregularities(irregularities) {
      const container = document.getElementById('irregularityShortcuts');
      if (!irregularities || irregularities.length === 0) {
        container.innerHTML = '<p class="no-data">Nessuna irregolarità trovata.</p>';
        return;
      }

      container.innerHTML = irregularities.map(item => `
        <button type="button" class="btn btn-sm" onclick="selectCalendarDate('${item.date}')">
          ${item.date} · ${item.status}
        </button>
      `).join('');
    }

    async function loadMonthCalendar(anchor) {
      lastActionAnchor = anchor || document.getElementById('calendarGrid');
      try {
        const response = await fetch(`/api/activities/month?date=${calendarDate}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        const result = await response.json();
        if (!result.success) {
          showError(result.error?.message || 'Errore nel caricamento del calendario');
          return;
        }

        const { month, days, irregularities } = result.data;
        const monthLabel = formatMonthLabel(`${month.year}-${String(month.month).padStart(2, '0')}-01`);
        document.getElementById('calendarMonthLabel').textContent = monthLabel;
        renderCalendar(days, month.year, month.month);
        renderIrregularities(irregularities);
      } catch (error) {
        console.error('Error loading month calendar:', error);
        showError('Errore nel caricamento del calendario');
      }
    }

    function navigateMonth(direction, anchor) {
      lastActionAnchor = anchor || document.getElementById('calendarGrid');
      const baseDate = new Date(`${calendarDate}T00:00:00`);
      baseDate.setMonth(baseDate.getMonth() + direction);
      calendarDate = baseDate.toISOString().split('T')[0];
      loadMonthCalendar();
    }

    function getQuickDayDurationParts() {
      const minutes = Number.isFinite(requiredMinutes) ? requiredMinutes : 480;
      const roundedMinutes = Math.min(24 * 60, Math.ceil(minutes / 15) * 15);
      const hours = Math.floor(roundedMinutes / 60);
      const remainder = roundedMinutes % 60;
      return { hours, minutes: remainder };
    }

    async function applyQuickDay(activityType, anchor, options = {}) {
      lastActionAnchor = anchor || document.querySelector('.quick-actions');
      if (!selectedCalendarDate) {
        showError('Seleziona prima un giorno dal calendario');
        return;
      }

      const duration = getQuickDayDurationParts();
      const payload = {
        date: selectedCalendarDate,
        activityType,
        durationHours: duration.hours,
        durationMinutes: duration.minutes,
        notes: options.notes || ''
      };

      if (options.label && activityType === 'permesso') {
        payload.notes = payload.notes ? `${payload.notes} (${options.label})` : options.label;
      }

      try {
        const response = await fetch('/api/activities', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        if (result.success) {
          loadActivities();
          loadMonthCalendar();
          showSuccess(`Giornata impostata: ${options.label || activityType}`);
        } else {
          showError(result.error?.message || 'Errore nel salvataggio');
        }
      } catch (error) {
        console.error('Quick day error:', error);
        showError('Errore nel salvataggio della giornata');
      }
    }

    console.log('Calling loadActivityTypes and loadActivities on page load...');
    populateDurationSelects();
    loadActivityTypes();
    loadActivities();
    loadMonthCalendar();

    helpSystem.init(userDashboardHelp);
  </script>
</body>
</html>
